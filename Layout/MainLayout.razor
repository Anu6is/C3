@using C3.Application.Interfaces
@inherits LayoutComponentBase

@inject WarSession WarSession
@inject IUserRepository UserRepo
@inject ProtectedTokenStore TokenStore
@inject BrowserStorageService SessionStore;

<MudThemeProvider IsDarkMode="true" Theme="@Theme"/>
<MudDialogProvider/>
<MudSnackbarProvider/>

<MudLayout>
    <Conditional Expression="@(CurrentUser is not null)" When="_initialized">
        <TrueContent>
            <WarData CurrentUser="@CurrentUser" WarSession="@WarSession" OnWarEnded="@WarEnded">
                <AppBar Username="@CurrentUser!.Username" FactionName="@CurrentUser!.Faction.Faction_Name" 
                        WarId="@WarSession.WarId" StartTime="@WarSession.StartTime" Winner="@Winner" />
                <MudMainContent Style="height:100vh;">
                    <MudContainer Class="mt-4" MaxWidth="MaxWidth.Large">
                        <AppErrorBoundary>
                            @Body
                        </AppErrorBoundary>
                    </MudContainer>
                </MudMainContent>
            </WarData>
        </TrueContent>
        <FalseContent>
            <SignIn OnSuccess="@SuccessfulSignin" />
        </FalseContent>
    </Conditional>
</MudLayout>

@code{
    private bool _initialized;
    private string? Winner { get; set; }
    private ApplicationUser? CurrentUser { get; set; }

    protected override async Task OnInitializedAsync()
    {
        CurrentUser = await GetCurrentUserAsync();

        _initialized = true;

        await base.OnInitializedAsync();
    }

    private async Task<ApplicationUser?> GetCurrentUserAsync()
    {
        WarSession = await SessionStore.GetUserSessionAsync();

        if (WarSession.EncryptedToken is null) return null;

        var token = await TokenStore.RefreshTokenAsync(WarSession.EncryptedToken);

        if (token is null) return null;

        var result = await UserRepo.GetCurrentUserAsync();

        if (result.IsFailure || result.Value is null) return null;

        var user = result.Value;

        var applicationUser = new ApplicationUser(
            user.PlayerId,
            user.Name,
            new TornUserFaction(user.Faction.FactionId, user.Faction.FactionName, user.Faction.FactionTag),
            new BattleStats(user.Stats.Strength, user.Stats.Defense, user.Stats.Speed, user.Stats.Dexterity),
            token)
        {
            State = Enum.TryParse<UserState>(user.State.State, out var state) ? state : UserState.Okay,
            ActivityStatus = Enum.TryParse<UserStatus>(user.Activity.Status, out var status) ? status : UserStatus.Offline
        };

        return applicationUser;
    }

    private void SuccessfulSignin(ApplicationUser user)
    {
        WarSession.EncryptedToken = TokenStore.EncryptedToken;
        CurrentUser = user;
    }

    private void WarEnded(string winner) => Winner = winner;

    private MudTheme Theme { get; } = new() 
    { 
        PaletteDark = new PaletteDark()
        {
            Primary = Colors.Gray.Darken2,
            Secondary = Colors.Gray.Darken3
        }
    };
}
