@using C3.Application.Interfaces
@inject IFactionRepository FactionRepo
@inject BrowserStorageService BrowserStore
@inject FilterStateContainer FilterState
@inject ISnackbar Snackbar
@inject ILogger<WarData> Logger
@inject TimerService TimerService
@implements IDisposable

<CascadingValue Value="@this">
    @if (_errorMessage is not null)
    {
        <ErrorState Title="Failed to load war details" Message="@_errorMessage" OnRetry="GetWarDetailsAsync" />
    }
    else
    {
    @if (!_initialized || UserFaction?.RankedWars.Count != 0)
    {
        @ChildContent
    }
    else
    {
        <MudContainer Class="d-flex flex-column justify-center" MaxWidth="MaxWidth.Small" Style="height:100vh;">
            <EmptyState
                Icon="@Icons.Material.Filled.Shield"
                Title="No Active War"
                Message="Your faction is not currently in a ranked war. This dashboard will activate when a war begins."
                ActionText="Refresh Status"
                ActionIcon="@Icons.Material.Filled.Refresh"
                OnAction="GetWarDetailsAsync" />
        </MudContainer>
    }
    }
</CascadingValue>

@code {
    [Parameter] public RenderFragment? ChildContent { get; set; }

    [EditorRequired][Parameter] public EventCallback<string> OnWarEnded { get; set; }
    [EditorRequired][Parameter] public required ApplicationUser? CurrentUser { get; set; }
    [EditorRequired][Parameter] public required WarSession WarSession { get; set; }

    private const int MaxApiFailureRetries = 3;
    public bool Initialized => _initialized;
    public WarDataChangeTracker ChangeTracker { get; } = new();
    private bool _initialized;
    private string? _errorMessage;
    private string? _monitorSubscriptionId;
    private int _monitorFailureCount;

    public FactionData? UserFaction { get; set; }
    public FactionData? RivalFaction { get; set; }
    public Dictionary<int, SpyData> Spies { get; set; } = [];

    protected override async Task OnInitializedAsync()
    {
        await GetWarDetailsAsync();

        await base.OnInitializedAsync();
    }

    private async Task GetWarDetailsAsync()
    {
        _errorMessage = null;
        var factionId = CurrentUser!.Faction.Faction_Id;

        var result = await FactionRepo.GetFactionDataAsync(factionId);

        if (result.IsFailure)
        {
            _errorMessage = result.Error;
            _initialized = true;
            StateHasChanged();
            return;
        }

        UserFaction = result.Value;

        if (UserFaction!.RankedWars.Count != 0)
        {
            var war = UserFaction!.RankedWars.First();

            WarSession.WarId = war.WarId;
            WarSession.StartTime = war.StartTime;

            var filterOptions = await BrowserStore.GetFilterOptionsAsync();

            if (filterOptions is not null)
            {
                if (filterOptions.WarId != war.WarId)
                {
                    await BrowserStore.DeleteFilterOptionsAsync();
                }
                else
                {
                    WarSession.FactionTargets = filterOptions.Targets;
                    FilterState.FromOptions(filterOptions);
                }
            }

            await BrowserStore.SaveSessionAsync(WarSession);
        }

        _initialized = true;

        StateHasChanged();
    }

    public async Task MonitorWarProgressAsync()
    {
        if (_monitorSubscriptionId != null) return;

        var rivalId = UserFaction!.RankedWars.First().FactionScores.First(x => x.Key != UserFaction.Id).Key;

        var spiesResult = await FactionRepo.GetFactionSpiesAsync(rivalId);

        if (spiesResult.IsSuccess && spiesResult.Value is not null)
        {
            var newSpies = spiesResult.Value;
            if (!AreSpiesEqual(Spies, newSpies))
            {
                Spies = newSpies;
                ChangeTracker.NotifyChanged();
                StateHasChanged();
            }
        }

        _monitorSubscriptionId = TimerService.Subscribe(async () => await TickWarMonitoring(rivalId), intervalTicks: 5);
    }

    private async Task TickWarMonitoring(int rivalId)
    {
        var result = await FactionRepo.GetFactionDataAsync(rivalId);

        if (result.IsSuccess)
        {
            _monitorFailureCount = 0;
            var newFaction = result.Value;
            if (HasFactionChanged(RivalFaction, newFaction))
            {
                RivalFaction = newFaction;
                ChangeTracker.NotifyChanged();
                StateHasChanged();
            }

            if (RivalFaction!.RankedWars.First().EndTime > 0)
            {
                if (_monitorSubscriptionId != null)
                {
                    TimerService.Unsubscribe(_monitorSubscriptionId);
                    _monitorSubscriptionId = null;
                }
            }
        }
        else
        {
            _monitorFailureCount++;
            Logger.LogWarning("Error fetching rival faction data: {Error}", result.Error);
            if (_monitorFailureCount >= MaxApiFailureRetries)
            {
                Snackbar.Add($"Failed to update war progress: {result.Error}", Severity.Error);
            }
        }
    }

    private bool HasFactionChanged(FactionData? oldF, FactionData? newF)
    {
        if (ReferenceEquals(oldF, newF)) return false;
        if (oldF == null || newF == null) return true;

        if (oldF.Members.Count != newF.Members.Count) return true;

        foreach (var (id, oldMember) in oldF.Members)
        {
            if (!newF.Members.TryGetValue(id, out var newMember) || oldMember != newMember)
                return true;
        }

        if (oldF.RankedWars.Count != newF.RankedWars.Count) return true;
        for (int i = 0; i < oldF.RankedWars.Count; i++)
        {
            var oldWar = oldF.RankedWars[i];
            var newWar = newF.RankedWars[i];

            if (oldWar.WarId != newWar.WarId ||
                oldWar.StartTime != newWar.StartTime ||
                oldWar.EndTime != newWar.EndTime ||
                oldWar.TargetScore != newWar.TargetScore ||
                oldWar.WinnerFactionId != newWar.WinnerFactionId)
                return true;

            if (oldWar.FactionScores.Count != newWar.FactionScores.Count) return true;
            foreach (var (fId, oldScore) in oldWar.FactionScores)
            {
                if (!newWar.FactionScores.TryGetValue(fId, out var newScore) || oldScore != newScore)
                    return true;
            }
        }

        return false;
    }

    private bool AreSpiesEqual(Dictionary<int, SpyData> oldSpies, Dictionary<int, SpyData> newSpies)
    {
        if (oldSpies.Count != newSpies.Count) return false;
        foreach (var (id, oldSpy) in oldSpies)
        {
            if (!newSpies.TryGetValue(id, out var newSpy) || oldSpy != newSpy)
                return false;
        }
        return true;
    }

    public void Dispose()
    {
        if (_monitorSubscriptionId != null)
        {
            TimerService.Unsubscribe(_monitorSubscriptionId);
            _monitorSubscriptionId = null;
        }
    }
}
