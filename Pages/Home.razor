@page "/"
@using MudBlazor
@using MudBlazor.Utilities
@using C3.Presentation.ViewModels
@using C3.Presentation.Enums

<MudStack AlignItems="AlignItems.Center" Justify="Justify.Center" Spacing="4" Style="width:100%">
    <MudHotkey Key="JsKey.KeyF" KeyModifiers="[JsKeyModifier.ControlLeft]" OnHotkeyPressed="FocusSearch" />
    <MudHotkey Key="JsKey.KeyF" KeyModifiers="[JsKeyModifier.ControlRight]" OnHotkeyPressed="FocusSearch" />
    <MudHotkey Key="JsKey.Escape" OnHotkeyPressed="ClearFilters" />
    <MudHotkey Key="JsKey.Slash" KeyModifiers="[JsKeyModifier.ControlLeft]" OnHotkeyPressed="ToggleMonitored" />
    <MudHotkey Key="JsKey.Slash" KeyModifiers="[JsKeyModifier.ControlRight]" OnHotkeyPressed="ToggleMonitored" />

    <WarTracker />

    <MudMessageBox @ref="_spyInfoBox" Title="Spy Data" YesText="OK">
        <MessageContent>
            Battle stats require spy reports from TornStats. Stats will appear as faction members are spied by your faction members and uploaded to TornStats.
        </MessageContent>
    </MudMessageBox>

    <AppErrorBoundary Title="Failed to Load War Data">
        @switch (_dataState)
        {
            case LoadingState.Loading:
                <DataGridSkeleton />
                break;
            case LoadingState.Loaded:
                @if (_viewModels.Count == 0)
                {
                    <EmptyState
                        Icon="@(HasHigherStats.HasValue && (Data?.Spies.Count ?? 0) == 0 ? Icons.Material.Filled.Security : Icons.Material.Filled.FilterAltOff)"
                        Title="@(HasHigherStats.HasValue && (Data?.Spies.Count ?? 0) == 0 ? "No Spy Data Available" : "No faction members match your filters")"
                        Message="@(HasHigherStats.HasValue && (Data?.Spies.Count ?? 0) == 0 ? "Battle stats require spy reports. Stats will appear as faction members are spied." : "Try adjusting your search criteria or filter settings to see more results.")"
                        ActionText="@(HasHigherStats.HasValue && (Data?.Spies.Count ?? 0) == 0 ? "Learn More" : "Clear All Filters")"
                        ActionIcon="@(HasHigherStats.HasValue && (Data?.Spies.Count ?? 0) == 0 ? Icons.Material.Filled.Info : Icons.Material.Filled.ClearAll)"
                        OnAction="@HandleEmptyStateAction" />
                }
                else
                {
                    <MudDataGrid @ref="@_dataGrid" T="FactionMemberViewModel" Items="@_viewModels" Style="width:100%;" Height="60vh" Virtualize="true"
                                 Class="mb-8" Dense="true" FixedHeader="true" FixedFooter="true" Filterable="false" Hover="true" SortMode="SortMode.Multiple">
                        <ToolBarContent>
                            <MudText Typo="Typo.h6">@Data?.RivalFaction?.Name</MudText>
                            <MudSpacer />
                            <MudTextField @ref="_searchField" @bind-Value="SearchString" Placeholder="Search" Adornment="Adornment.Start" Immediate="true" Margin="Margin.Dense"
                                          AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-n4 px-4" Clearable="true" />
                            <MudToggleIconButton Icon="@Icons.Material.Filled.KeyboardDoubleArrowDown" ToggledIcon="@Icons.Material.Filled.KeyboardDoubleArrowUp"
                                                 Color="@(HasHigherStats is null ? Color.Default : Color.Success)" ToggledColor="Color.Error"
                                                 Toggled="@(HasHigherStats ?? false)" ToggledChanged="@OnToggleChanged" />
                            <MudChipSet Class="d-none d-sm-flex" SelectionMode="SelectionMode.MultiSelection" CheckMark @bind-SelectedValues="@SelectedValues">
                                <MudChip Text="Okay" Color="Color.Primary" SelectedColor="Color.Success" Label="true" Size="Size.Medium" Style="width:80px;" Value="@("Okay")" Icon="@Icons.Material.Filled.CheckCircle" />
                                <MudChip Text="Hospital" Color="Color.Primary" SelectedColor="Color.Error" Label="true" Size="Size.Medium" Style="width:80px;" Value="@("Hospital")" Icon="@Icons.Material.Filled.LocalHospital" />
                            </MudChipSet>
                            <MudChipSet Class="d-flex d-sm-none" SelectionMode="SelectionMode.MultiSelection" CheckMark @bind-SelectedValues="@SelectedValues">
                                <MudChip Color="Color.Primary" SelectedColor="Color.Success" Label="true" Size="Size.Medium" Value="@("Okay")" Icon="@Icons.Material.Filled.CheckCircle" />
                                <MudChip Color="Color.Primary" SelectedColor="Color.Error" Label="true" Size="Size.Medium" Value="@("Hospital")" Icon="@Icons.Material.Filled.LocalHospital" />
                            </MudChipSet>
                        </ToolBarContent>
                        <Columns>
                            <PropertyColumn Property="@(x => x.Id)" Hidden="true" />
                            <TemplateColumn Title="Name" SortBy="@(x => x.Name)">
                                <CellTemplate>
                                    <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Style="width:200px;">
                                        <MudBadge Class="pl-4" Color="@context.Item.StatusColor" Overlap="false" Origin="Origin.CenterLeft" Dot="true">
                                            <MudLink Color="Color.Info" Href="@context.Item.ProfileUrl" Target="_blank">@context.Item.Name</MudLink>
                                        </MudBadge>
                                        <MudIconButton Icon="@Icons.Material.Filled.LocationSearching" Color="Color.Error" Size="Size.Small" Title="Attack" Href="@context.Item.AttackUrl" Target="_blank" />
                                    </MudStack>
                                </CellTemplate>
                            </TemplateColumn>
                            <PropertyColumn Property="@(x => x.Level)" />
                            <TemplateColumn Title="Total Stats" SortBy="@(x => x.BattleStats)">
                                <CellTemplate>
                                    <MudTooltip Color="Color.Primary" Arrow="true" Placement="Placement.Top" ShowOnClick="@context.Item.HasSpyData" ShowOnHover="@context.Item.HasSpyData">
                                        <ChildContent><MudText Color="@context.Item.BattleStatsColor">@context.Item.BattleStatsDisplay</MudText></ChildContent>
                                        <TooltipContent>
                                            @foreach (var stat in new[] { ("Strength", context.Item.StrengthText, context.Item.StrengthColor), ("Defense", context.Item.DefenseText, context.Item.DefenseColor), ("Speed", context.Item.SpeedText, context.Item.SpeedColor), ("Dexterity", context.Item.DexterityText, context.Item.DexterityColor) }) {
                                                <MudText Typo="Typo.caption" Color="@stat.Item3">@($"{stat.Item1}: {stat.Item2}")</MudText><br />
                                            }
                                        </TooltipContent>
                                    </MudTooltip>
                                </CellTemplate>
                            </TemplateColumn>
                            <TemplateColumn Title="State" SortBy="@(x => x.StateDisplay)">
                                <CellTemplate><MudChip Color="@context.Item.StateColor" Icon="@context.Item.StateIcon" Text="@context.Item.StateDisplay" Size="Size.Small" /></CellTemplate>
                            </TemplateColumn>
                            <TemplateColumn Title="Until" SortBy="@(x => x.StateUntil)">
                                <CellTemplate><Countdown Seconds="@context.Item.StateUntil" /></CellTemplate>
                            </TemplateColumn>
                            <TemplateColumn Title="Monitor" SortBy="@(x => x.IsMonitored)">
                                <CellTemplate>
                                    <MudToggleIconButton Variant="Variant.Filled" Toggled="@context.Item.IsMonitored" Size="Size.Small" ToggledSize="Size.Small" Color="Color.Default" ToggledColor="Color.Error"
                                                         ToggledChanged="@(async (x) => await ToggleMonitoringAsync(x, context.Item.Id))" Icon="@Icons.Material.Filled.CrisisAlert" ToggledIcon="@Icons.Material.Filled.CrisisAlert" />
                                </CellTemplate>
                            </TemplateColumn>
                        </Columns>
                        <PagerContent>
                            <MudStack Row="true" Class="pl-8" AlignItems="AlignItems.Center" Style="width:100%">
                                <MudSwitch @bind-Value="@Monitored" Color="Color.Error" Size="@(IsMobile ? Size.Small : Size.Medium)">Monitored Only</MudSwitch>
                                <MudSpacer /><MudDataGridPager T="FactionMemberViewModel" />
                            </MudStack>
                        </PagerContent>
                    </MudDataGrid>
                }
                break;
            case LoadingState.Error:
                <ErrorState Title="Failed to load faction data" OnRetry="() => OnInitializedAsync()" />
                break;
        }
    </AppErrorBoundary>
</MudStack>
